\ProvidesPackage{style/form-elements}[2025/08/04 CTMM Interactive Forms v2.0.0]

% Required packages
\RequirePackage{tikz}
\RequirePackage{xcolor}
\RequirePackage{ifthen}
\RequirePackage{calc}
\RequirePackage{forloop}
\RequirePackage{pifont}  % Für Checkbox-Symbole
% Hyperref wird bereits in main.tex geladen

% Wichtig für \@ifpackageloaded
\makeatletter
% Interactive Form Detection
\newcommand{\@ctmmInteractive}{true}

% Check if hyperref is loaded for interactive forms
\@ifpackageloaded{hyperref}{%
    % hyperref is already loaded - just enable interactive mode
    \renewcommand{\@ctmmInteractive}{true}%
}{%
    % hyperref not loaded - load it and enable interactive mode
    \RequirePackage{hyperref}%
    \renewcommand{\@ctmmInteractive}{true}%
}
\makeatother

% Text Field mit verbessertem Design
% Usage: \ctmmTextField[width]{default text}{field name}
\newcommand{\ctmmTextField}[3][4cm]{%
    \ifthenelse{\equal{\@ctmmInteractive}{true}}{%
        \TextField[%
            name=#3,%
            width=#1,%
            height=14pt,%
            bordercolor=ctmmBlue,%
            backgroundcolor=ctmmBlue!2!white,%
            borderwidth=1pt,%
            borderstyle=S,%
            charsize=10pt,%
            maxlen=100,%
            default={#2}%
        ]{}%
    }{%
        \underline{\hspace{#1}}%
    }%
}

% Text area
% Usage: \ctmmTextArea[width]{lines}{field name}{default text}
\newcounter{ctmmTextAreaLine}
\newcommand{\ctmmTextArea}[4][12cm]{%
    \ifthenelse{\equal{\@ctmmInteractive}{true}}{%
        \TextField[%
            name=#3,%
            width=#1,%
            height=\the\numexpr #2*15\relax pt,%
            multiline=true,%
            bordercolor=ctmmBlue,%
            backgroundcolor=white,%
            borderwidth=1pt,%
            borderstyle=S,%
            charsize=10pt,%
            default={#4}%
        ]{}%
    }{%
        \parbox[t]{#1}{%
            \vspace{0.2cm}%
            \forloop{ctmmTextAreaLine}{1}{\value{ctmmTextAreaLine} < \numexpr#2+1\relax}{%
                \underline{\hspace{\linewidth}}\\[1.5ex]%
            }%
        }%
    }%
}

% Checkbox mit verbessertem Design
% Usage: \ctmmCheckBox[field name]{label} (backward compatible - field name is optional)
%        \ctmmCheckBox{field name}{label} (new style)
\newcommand{\ctmmCheckBox}[2][]{%
    \ifthenelse{\equal{#1}{}}{%
        % Old style: first parameter is field name, second is label
        \ifthenelse{\equal{\@ctmmInteractive}{true}}{%
            \CheckBox[%
                name=#2,%
                width=14pt,%
                height=14pt,%
                bordercolor=ctmmGreen,%
                backgroundcolor=white,%
                borderwidth=1.5pt,%
                borderstyle=S,%
                checkboxsymbol={\textcolor{ctmmGreen}{\ding{51}}}%
            ]{\raisebox{0.1ex}{\small\,#2}}%
        }{%
            \raisebox{-0.1ex}{\tikz[baseline=-0.1ex]{\draw[color=ctmmGreen, line width=1pt] (0,0) rectangle (0.35,0.35);}} {\small\,#2}%
        }%
    }{%
        % New style: first parameter is field name, second is label
        \ifthenelse{\equal{\@ctmmInteractive}{true}}{%
            \CheckBox[%
                name=#1,%
                width=14pt,%
                height=14pt,%
                bordercolor=ctmmGreen,%
                backgroundcolor=white,%
                borderwidth=1.5pt,%
                borderstyle=S,%
                checkboxsymbol={\textcolor{ctmmGreen}{\ding{51}}}%
            ]{\raisebox{0.1ex}{\small\,#2}}%
        }{%
            \raisebox{-0.1ex}{\tikz[baseline=-0.1ex]{\draw[color=ctmmGreen, line width=1pt] (0,0) rectangle (0.35,0.35);}} {\small\,#2}%
        }%
    }%
}

% Radio Button
% Usage: \ctmmRadioButton{group name}{field value}{label}
\newcommand{\ctmmRadioButton}[3]{%
    \ifthenelse{\equal{\@ctmmInteractive}{true}}{%
        \ChoiceMenu[radio,name=#1]{}{#2=#3}%
    }{%
        \raisebox{-0.1ex}{\tikz{\draw[color=ctmmGreen, rounded corners] (0,0) rectangle (0.3,0.3);}} #3%
    }%
}

% Daily Input for tables
\newcommand{\dailyInput}{\underline{\hspace{0.7cm}}}

% =====================================================
% CTMM-Specific Form Elements
% =====================================================

% Date input
\newcommand{\ctmmDate}[1]{%
    \textbf{Datum:} \ctmmTextField[3cm]{}{date#1}%
}

% Date input field with custom label and placeholder
\newcommand{\ctmmDateField}[3]{%
    \textbf{#2:} \ctmmTextField[3cm]{#3}{#1}%
}

% Time input
\newcommand{\ctmmTime}[1]{%
    \textbf{Zeit:} \ctmmTextField[2cm]{}{time#1} Uhr%
}

% Time input field with custom label
\newcommand{\ctmmTimeField}[2]{%
    \textbf{#2:} \ctmmTextField[2cm]{}{#1} Uhr%
}

% Stress Level (10-100 with text field)
\newcommand{\ctmmStressLevel}[1]{%
    \textbf{Stresslevel (10-100):} \ctmmTextField[2cm]{}{stress#1}%
}

% Yes/No Checkbox pair
\newcommand{\ctmmYesNo}[1]{%
    \ctmmCheckBox{#1yes}{Ja} \quad \ctmmCheckBox{#1no}{Nein}%
}

% Emotion Check-in Scale
\newcommand{\ctmmEmotionScale}[2]{%
    \textbf{#1:}\\%
    \begin{tabular}{lllllllllll}
    \small 1 & \small 2 & \small 3 & \small 4 & \small 5 & \small 6 & \small 7 & \small 8 & \small 9 & \small 10\\
    \ctmmRadioButton{#2}{1}{} &
    \ctmmRadioButton{#2}{2}{} &
    \ctmmRadioButton{#2}{3}{} &
    \ctmmRadioButton{#2}{4}{} &
    \ctmmRadioButton{#2}{5}{} &
    \ctmmRadioButton{#2}{6}{} &
    \ctmmRadioButton{#2}{7}{} &
    \ctmmRadioButton{#2}{8}{} &
    \ctmmRadioButton{#2}{9}{} &
    \ctmmRadioButton{#2}{10}{}\\
    \end{tabular}%
}

% Trigger intensity (color-coded scale)
\newcommand{\ctmmTriggerScale}[1]{%
    \textbf{Trigger-Intensität:}\\%
    \textcolor{ctmmGreen}{\ctmmRadioButton{trigger#1}{1}{1-2 (leicht)}} \quad%
    \textcolor{ctmmOrange}{\ctmmRadioButton{trigger#1}{3}{3-5 (mittel)}} \quad%
    \textcolor{ctmmRed}{\ctmmRadioButton{trigger#1}{5}{6-10 (stark)}}%
}

% Safe word selection
\newcommand{\ctmmSafeWordOptions}[1]{%
    \textbf{Safe-Word verwendet:}\\%
    \ctmmCheckBox{#1anker}{„Anker!"} \quad%
    \ctmmCheckBox{#1reset}{„Reset!"} \quad%
    \ctmmCheckBox{#1eiszeit}{„Eiszeit!"} \quad%
    \ctmmCheckBox{#1other}{Anderes:} \ctmmTextField[3cm]{}{#1otherword}%
}

% Weekly Pattern Table
\newcommand{\ctmmWeeklyPattern}[1]{%
    \begin{center}
    \begin{tabular}{|l|c|c|c|c|c|c|c|}
    \hline
    \textbf{Tag} & \textbf{Mo} & \textbf{Di} & \textbf{Mi} & \textbf{Do} & \textbf{Fr} & \textbf{Sa} & \textbf{So} \\
    \hline
    \textbf{Stimmung} & \ctmmTextField[1cm]{}{#1mo} & \ctmmTextField[1cm]{}{#1di} & \ctmmTextField[1cm]{}{#1mi} & \ctmmTextField[1cm]{}{#1do} & \ctmmTextField[1cm]{}{#1fr} & \ctmmTextField[1cm]{}{#1sa} & \ctmmTextField[1cm]{}{#1so} \\
    \hline
    \end{tabular}
    \end{center}%
}

% Complete Daily Tracker
\newcommand{\ctmmDailyTracker}[1]{%
    \begin{ctmmGreenBox}[title=Täglicher CTMM-Tracker]
    \ctmmDate{#1dt} \quad \ctmmTime{#1dt}\\[0.3cm]

    \ctmmEmotionScale{Morgenstimmung}{#1morning}\\[0.3cm]
    \ctmmEmotionScale{Abendstimmung}{#1evening}\\[0.3cm]

    \ctmmTriggerScale{#1dt}\\[0.3cm]

    \textbf{Strategien angewendet:}\\
    \ctmmCheckBox{#1breathing}{Atemtechnik} \quad
    \ctmmCheckBox{#1grounding}{Grounding} \quad
    \ctmmCheckBox{#1pause}{Pause} \quad
    \ctmmCheckBox{#1talk}{Gespräch}\\[0.3cm]

    \textbf{Reflexion:}\\
    \ctmmTextArea[14cm]{3}{#1reflection}{}
    \end{ctmmGreenBox}%
}

% Crisis Protocol Quick Form
\newcommand{\ctmmCrisisForm}[1]{%
    \begin{ctmmRedBox}[title=\textcolor{white}{Krisen-Protokoll}]
    \textcolor{white}{\textbf{Zeitpunkt:}} \textcolor{white}{\ctmmDate{#1cr}} \textcolor{white}{\ctmmTime{#1cr}}\\[0.3cm]

    \textcolor{white}{\textbf{Safe-Word verwendet:}}\\
    \textcolor{white}{\ctmmCheckBox{#1anker}{Anker} \quad \ctmmCheckBox{#1reset}{Reset} \quad \ctmmCheckBox{#1pause}{Pause}}\\[0.3cm]

    \textcolor{white}{\textbf{Maßnahmen:}}\\
    \textcolor{white}{\ctmmTextArea[14cm]{2}{#1measures}{}}
    \end{ctmmRedBox}%
}
