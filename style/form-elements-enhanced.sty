% =====================================================
% CTMM Form Elements Package - Enhanced Version
% Purpose: Interactive and printable form elements for CTMM worksheets
% Author: CTMM-Team  
% Version: 2.0.0 (August 2025)
% Copilot: Use for creating interactive PDFs and printable forms
% =====================================================

\ProvidesPackage{form-elements-enhanced}[2025/08/04 CTMM Form Elements Enhanced v2.0.0]

% Required packages
\RequirePackage{tikz}
\RequirePackage{xcolor}
\RequirePackage{ifthen}
\RequirePackage{calc}
\RequirePackage{forloop}
\RequirePackage{pifont}

% Wichtig für \@ifpackageloaded
\makeatletter
% Check if hyperref is loaded for interactive forms
\@ifpackageloaded{hyperref}{%
    \newcommand{\@ctmmInteractive}{true}%
}{%
    \newcommand{\@ctmmInteractive}{false}%
}
\makeatother

% Load CTMM colors if not already loaded
\@ifpackageloaded{ctmm-design}{}{%
    \definecolor{ctmmBlue}{HTML}{003087}
    \definecolor{ctmmGreen}{HTML}{4CAF50}
    \definecolor{ctmmOrange}{HTML}{FF6200}
    \definecolor{ctmmRed}{HTML}{D32F2F}
    \definecolor{ctmmPurple}{HTML}{7B1FA2}
}

% =====================================================
% Basic Form Elements
% =====================================================

% Text Field (interactive if hyperref loaded, otherwise underline)
\newcommand{\ctmmTextField}[3][4cm]{%
    \ifthenelse{\equal{\@ctmmInteractive}{true}}{%
        \TextField[%
            name=#3,%
            width=#1,%
            height=14pt,%
            bordercolor=ctmmBlue,%
            backgroundcolor=ctmmBlue!2!white,%
            borderwidth=1pt,%
            borderstyle=S,%
            charsize=10pt,%
            maxlen=100,%
            default={#2}%
        ]{}%
    }{%
        #2 \underline{\hspace{#1}}%
    }%
}

% Large text area
\newcounter{ctmmTextAreaLine}
\newcommand{\ctmmTextArea}[4][8cm]{%
    \ifthenelse{\equal{\@ctmmInteractive}{true}}{%
        \TextField[%
            name=#4,%
            width=#1,%
            height=\the\numexpr #3*15\relax pt,%
            multiline=true,%
            bordercolor=ctmmBlue,%
            backgroundcolor=white,%
            borderwidth=1pt,%
            borderstyle=S,%
            charsize=10pt,%
            default={#2}%
        ]{}%
    }{%
        #2\\%
        \forloop{ctmmTextAreaLine}{1}{\value{ctmmTextAreaLine} < \numexpr#3+1\relax}{%
            \underline{\hspace{#1}}\\[1.5ex]%
        }%
    }%
}

% =====================================================
% Checkboxes and Radio Buttons
% =====================================================

% Checkbox
\newcommand{\ctmmCheckBox}[2][]{%
    \ifthenelse{\equal{\@ctmmInteractive}{true}}{%
        \CheckBox[%
            name=#1,%
            width=14pt,%
            height=14pt,%
            bordercolor=ctmmGreen,%
            backgroundcolor=white,%
            borderwidth=1.5pt,%
            borderstyle=S,%
            checkboxsymbol={\textcolor{ctmmGreen}{\ding{51}}}%
        ]{\raisebox{0.1ex}{\small\,#2}}%
    }{%
        \raisebox{-0.15ex}{\tikz{\draw[color=ctmmGreen] (0,0) rectangle (0.3,0.3);}} #2%
    }%
}

% Radio Button Group
\newcommand{\ctmmRadioButton}[3]{%
    \ifthenelse{\equal{\@ctmmInteractive}{true}}{%
        \RadioButton[name=#1,bordercolor=ctmmOrange]{#2}{#3}%
    }{%
        \raisebox{-0.05ex}{\tikz{\draw[color=ctmmOrange] (0,0) circle (0.15);}} #3%
    }%
}

% =====================================================
% CTMM-Specific Form Elements
% =====================================================

% Mood Scale (1-10 with radio buttons)
\newcommand{\ctmmMoodScale}[1]{%
    \textbf{#1:}\\%
    \foreach \n in {1,2,3,4,5,6,7,8,9,10}{%
        \ctmmRadioButton{mood#1}{\n}{\n} \quad%
    }%
}

% Stress Level (10-100 with text field)
\newcommand{\ctmmStressLevel}[1]{%
    \textbf{Stresslevel #1 (10-100):} \ctmmTextField[2cm]{}{stress#1}%
}

% Yes/No Checkbox pair
\newcommand{\ctmmYesNo}[1]{%
    \ctmmCheckBox[#1yes]{Ja} \quad \ctmmCheckBox[#1no]{Nein}%
}

% =====================================================
% Time and Date Inputs
% =====================================================

% Date input
\newcommand{\ctmmDate}[1]{%
    \textbf{Datum:} \ctmmTextField[3cm]{}{date#1}%
}

% Time input  
\newcommand{\ctmmTime}[1]{%
    \textbf{Zeit:} \ctmmTextField[2cm]{}{time#1} Uhr%
}

% Duration input
\newcommand{\ctmmDuration}[1]{%
    \textbf{Dauer:} \ctmmTextField[2cm]{}{duration#1} Min%
}

% =====================================================
% CTMM Color-Coded Elements
% =====================================================

% Trigger intensity (color-coded scale)
\newcommand{\ctmmTriggerScale}[1]{%
    \textbf{Trigger-Intensität:}\\%
    \textcolor{ctmmGreen}{\ctmmRadioButton{trigger#1}{1}{1-2 (leicht)}} \quad%
    \textcolor{ctmmOrange}{\ctmmRadioButton{trigger#1}{3}{3-5 (mittel)}} \quad%
    \textcolor{ctmmRed}{\ctmmRadioButton{trigger#1}{5}{6-10 (stark)}}%
}

% Safe word selection
\newcommand{\ctmmSafeWordOptions}[1]{%
    \textbf{Safe-Word verwendet:}\\%
    \ctmmCheckBox[#1anker]{„Anker!"} \quad%
    \ctmmCheckBox[#1reset]{„Reset!"} \quad%
    \ctmmCheckBox[#1eiszeit]{„Eiszeit!"} \quad%
    \ctmmCheckBox[#1other]{Anderes:} \ctmmTextField[3cm]{}{#1otherword}%
}

% =====================================================
% CTMM Therapy-Specific Elements
% =====================================================

% Emotion Check-in Scale
\newcommand{\ctmmEmotionScale}[2]{%
    \textbf{#1:}\\%
    \begin{tabular}{lllllllllll}
    \small 1 & \small 2 & \small 3 & \small 4 & \small 5 & \small 6 & \small 7 & \small 8 & \small 9 & \small 10\\
    \ctmmRadioButton{#2}{1}{} & 
    \ctmmRadioButton{#2}{2}{} & 
    \ctmmRadioButton{#2}{3}{} & 
    \ctmmRadioButton{#2}{4}{} & 
    \ctmmRadioButton{#2}{5}{} & 
    \ctmmRadioButton{#2}{6}{} & 
    \ctmmRadioButton{#2}{7}{} & 
    \ctmmRadioButton{#2}{8}{} & 
    \ctmmRadioButton{#2}{9}{} & 
    \ctmmRadioButton{#2}{10}{}\\
    \end{tabular}%
}

% Quick Check-in Box
\newcommand{\ctmmQuickCheck}[1]{%
    \begin{ctmmBlueBox}[title=Quick Check-in]
    \ctmmDate{#1} \quad \ctmmTime{#1}\\[0.3cm]
    \ctmmEmotionScale{Stimmung}{#1mood}\\[0.3cm]
    \ctmmStressLevel{#1}\\[0.3cm]
    \textbf{Kurze Notiz:} \ctmmTextField[8cm]{}{#1note}
    \end{ctmmBlueBox}%
}

% Weekly Pattern Table
\newcommand{\ctmmWeeklyPattern}[1]{%
    \begin{center}
    \begin{tabular}{|l|c|c|c|c|c|c|c|}
    \hline
    \textbf{Tag} & \textbf{Mo} & \textbf{Di} & \textbf{Mi} & \textbf{Do} & \textbf{Fr} & \textbf{Sa} & \textbf{So} \\
    \hline
    \textbf{Stimmung} & \ctmmTextField[1cm]{}{#1mo} & \ctmmTextField[1cm]{}{#1di} & \ctmmTextField[1cm]{}{#1mi} & \ctmmTextField[1cm]{}{#1do} & \ctmmTextField[1cm]{}{#1fr} & \ctmmTextField[1cm]{}{#1sa} & \ctmmTextField[1cm]{}{#1so} \\
    \hline
    \end{tabular}
    \end{center}%
}

% =====================================================
% Table Helpers for Forms
% =====================================================

% Two-column comparison table
\newcommand{\ctmmComparisonTable}[4]{%
    \begin{tabular}{|p{7cm}|p{7cm}|}
    \hline
    \textbf{#1} & \textbf{#2} \\
    \hline
    #3 & #4 \\
    \hline
    \end{tabular}%
}

% =====================================================
% Form Validation (for interactive PDFs)
% =====================================================

% Required field marker
\newcommand{\ctmmRequired}{%
    \textcolor{ctmmRed}{*}%
}

% Form section divider
\newcommand{\ctmmFormSection}[2]{%
    \vspace{0.5cm}%
    \textcolor{#1}{\textbf{#2}}%
    \hrule height 1pt%
    \vspace{0.3cm}%
}

% =====================================================
% Enhanced CTMM Tools
% =====================================================

% Complete Daily Tracker
\newcommand{\ctmmDailyTracker}[1]{%
    \begin{ctmmGreenBox}[title=Täglicher CTMM-Tracker]
    \ctmmDate{#1dt} \quad \ctmmTime{#1dt}\\[0.3cm]
    
    \ctmmEmotionScale{Morgenstimmung}{#1morning}\\[0.3cm]
    \ctmmEmotionScale{Abendstimmung}{#1evening}\\[0.3cm]
    
    \ctmmTriggerScale{#1dt}\\[0.3cm]
    
    \textbf{Strategien angewendet:}\\
    \ctmmCheckBox[#1breathing]{Atemtechnik} \quad 
    \ctmmCheckBox[#1grounding]{Grounding} \quad 
    \ctmmCheckBox[#1pause]{Pause} \quad 
    \ctmmCheckBox[#1talk]{Gespräch}\\[0.3cm]
    
    \textbf{Reflexion:}\\
    \ctmmTextArea[14cm]{3}{#1reflection}{}
    \end{ctmmGreenBox}%
}

% Crisis Protocol Quick Form
\newcommand{\ctmmCrisisForm}[1]{%
    \begin{ctmmRedBox}[title=\textcolor{white}{Krisen-Protokoll}]
    \textcolor{white}{\textbf{Zeitpunkt:}} \textcolor{white}{\ctmmDate{#1cr}} \textcolor{white}{\ctmmTime{#1cr}}\\[0.3cm]
    
    \textcolor{white}{\textbf{Safe-Word verwendet:}}\\
    \textcolor{white}{\ctmmCheckBox[#1anker]{Anker} \quad \ctmmCheckBox[#1reset]{Reset} \quad \ctmmCheckBox[#1pause]{Pause}}\\[0.3cm]
    
    \textcolor{white}{\textbf{Maßnahmen:}}\\
    \textcolor{white}{\ctmmTextArea[14cm]{2}{#1measures}{}}
    \end{ctmmRedBox}%
}

% =====================================================
% End of Package
% =====================================================
