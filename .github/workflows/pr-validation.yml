name: PR Content Validation

"on":
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-pr-content:
    runs-on: ubuntu-latest
    name: Validate PR has reviewable content
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check for file changes
      id: changes
      timeout-minutes: 5
      run: |
        # Get the base and head commits
        BASE_SHA="${{ github.event.pull_request.base.sha }}"
        HEAD_SHA="${{ github.event.pull_request.head.sha }}"
        
        # Validate that we have valid SHAs
        if [ -z "$BASE_SHA" ] || [ -z "$HEAD_SHA" ]; then
          echo "‚ùå Error: Unable to get base or head SHA"
          echo "BASE_SHA: $BASE_SHA"
          echo "HEAD_SHA: $HEAD_SHA"
          exit 1
        fi
        
        # Count changed files with error handling
        CHANGED_FILES=$(git diff --name-only $BASE_SHA..$HEAD_SHA 2>/dev/null | wc -l || echo "0")
        ADDED_LINES=$(git diff --numstat $BASE_SHA..$HEAD_SHA 2>/dev/null | awk 'BEGIN{sum=0} {sum += $1} END {print sum+0}' || echo "0")
        DELETED_LINES=$(git diff --numstat $BASE_SHA..$HEAD_SHA 2>/dev/null | awk 'BEGIN{sum=0} {sum += $2} END {print sum+0}' || echo "0")
        
        echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "added_lines=$ADDED_LINES" >> $GITHUB_OUTPUT
        echo "deleted_lines=$DELETED_LINES" >> $GITHUB_OUTPUT
        
        echo "üìä PR Statistics:"
        echo "- Changed files: $CHANGED_FILES"
        echo "- Added lines: $ADDED_LINES"
        echo "- Deleted lines: $DELETED_LINES"
        
    - name: Validate PR has content
      timeout-minutes: 5
      run: |
        CHANGED_FILES="${{ steps.changes.outputs.changed_files }}"
        ADDED_LINES="${{ steps.changes.outputs.added_lines }}"
        DELETED_LINES="${{ steps.changes.outputs.deleted_lines }}"
        
        # Convert to numbers with fallback
        CHANGED_FILES=${CHANGED_FILES:-0}
        ADDED_LINES=${ADDED_LINES:-0}
        DELETED_LINES=${DELETED_LINES:-0}
        
        echo "üîç Validating PR content..."
        echo "- Changed files: $CHANGED_FILES"
        echo "- Added lines: $ADDED_LINES"
        echo "- Deleted lines: $DELETED_LINES"
        
        if [ "$CHANGED_FILES" -eq 0 ]; then
          echo "‚ùå Error: This PR has no file changes."
          echo "Copilot cannot review PRs without any changed files."
          echo "Please ensure your PR includes actual code or documentation changes."
          exit 1
        fi
        
        if [ "$ADDED_LINES" -eq 0 ] && [ "$DELETED_LINES" -eq 0 ]; then
          echo "‚ùå Error: This PR has no content changes (0 additions, 0 deletions)."
          echo "Please include meaningful changes for Copilot to review."
          exit 1
        fi
        
        echo "‚úÖ PR validation passed: $CHANGED_FILES file(s) changed, $ADDED_LINES line(s) added, $DELETED_LINES line(s) deleted"
        
    - name: Run CTMM build check
      timeout-minutes: 10
      run: |
        echo "üõ†Ô∏è  Running CTMM build validation with enhanced error handling..."
        ./ci_robustness_helper.sh run-build-system
        
    - name: Enhanced PR validation
      timeout-minutes: 5
      run: |
        echo "üîç Running enhanced PR validation..."
        ./ci_robustness_helper.sh validate-pr
    - name: Comment on PR if validation fails
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ‚ö†Ô∏è PR Content Validation Failed

              This pull request appears to have no reviewable content:
              - Changed files: ${{ steps.changes.outputs.changed_files }}
              - Added lines: ${{ steps.changes.outputs.added_lines }}
              - Deleted lines: ${{ steps.changes.outputs.deleted_lines }}

              **Why this matters:** Copilot cannot review pull requests that contain no file changes or content modifications.
              
              ### To fix this issue:
              1. Ensure you have committed and pushed actual changes to files
              2. Check that your changes are included in this PR branch
              3. Verify the PR is comparing the correct base and head branches
              ### Need help?
              - Review the [contributing guidelines](README.md)
              - Check the [CTMM build system documentation](.github/copilot-instructions.md)
              - Run \\\`python3 ctmm_build.py\\\` locally to test your changes`
          })