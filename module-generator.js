#!/usr/bin/env node
/**
 * CTMM Module Generator
 * 
 * A comprehensive module generation system for the CTMM (Catch-Track-Map-Match)
 * therapeutic materials system. Generates standardized LaTeX modules for
 * German language therapy materials targeting neurodiverse couples.
 */

const fs = require('fs');
const path = require('path');
const readline = require('readline');

// CTMM Color Scheme Constants
const CTMM_COLORS = {
    blue: '#003087',
    orange: '#FF6200', 
    green: '#4CAF50',
    purple: '#7B1FA2',
    red: '#D32F2F',
    gray: '#757575',
    yellow: '#FFC107'
};

/**
 * Module template generators for different therapeutic content types
 */
class CTMMModuleGenerator {
    constructor() {
        this.moduleTypes = {
            'arbeitsblatt': 'Arbeitsblatt (Worksheet)',
            'tool': 'Therapeutisches Tool (Therapeutic Tool)', 
            'notfallkarte': 'Notfallkarte (Emergency Card)'
        };
    }

    /**
     * Generate Arbeitsblatt (Worksheet) template
     */
    generateArbeitsblatt(title, description, filename) {
        return `% ${filename} - CTMM Arbeitsblatt
% Generated by CTMM Module Generator
% Therapeutic worksheet for neurodiverse couples therapy

\\section{${title}}
\\label{sec:${filename.replace('.tex', '').replace(/[^a-zA-Z0-9]/g, '-')}}

\\begin{ctmmBlueBox}{Anleitung f√ºr Therapeut*innen}
${description || 'Dieses Arbeitsblatt unterst√ºtzt Paare bei der strukturierten Selbstreflexion und f√∂rdert die therapeutische Arbeit nach der CTMM-Methodik (Catch-Track-Map-Match).'}
\\end{ctmmBlueBox}

\\subsection{Zielsetzung}
\\begin{itemize}
    \\item \\textbf{Catch}: Erkennung und Wahrnehmung von Mustern und Triggern
    \\item \\textbf{Track}: Systematische Dokumentation von Beobachtungen
    \\item \\textbf{Map}: Zuordnung und Verst√§ndnis von Zusammenh√§ngen
    \\item \\textbf{Match}: Anpassung und Entwicklung passender Strategien
\\end{itemize}

\\subsection{Arbeitsbereich}

\\begin{ctmmGreenBox}{Schritt 1: Situationserfassung}
\\textbf{Beschreiben Sie die aktuelle Situation:}

\\ctmmTextArea[12cm]{4}{Situation}{situation}

\\vspace{0.5cm}
\\textbf{Beteiligte Personen:}
\\ctmmTextField[8cm]{Personen}{personen}

\\textbf{Datum/Zeit:}
\\ctmmTextField[4cm]{Datum}{datum}
\\end{ctmmGreenBox}

\\vspace{1cm}

\\begin{ctmmBlueBox}{Schritt 2: Gef√ºhle und Gedanken}
\\textbf{Welche Gef√ºhle nehmen Sie wahr?}

\\ctmmCheckBox[angst]{Angst}
\\ctmmCheckBox[trauer]{Trauer}
\\ctmmCheckBox[wut]{Wut}
\\ctmmCheckBox[freude]{Freude}
\\ctmmCheckBox[unsicherheit]{Unsicherheit}
\\ctmmCheckBox[entspannung]{Entspannung}

\\vspace{0.5cm}
\\textbf{Beschreiben Sie Ihre Gedanken:}
\\ctmmTextArea[12cm]{3}{Gedanken}{gedanken}
\\end{ctmmBlueBox}

\\vspace{1cm}

\\begin{ctmmPurpleBox}{Schritt 3: K√∂rperliche Wahrnehmung}
\\textbf{Welche k√∂rperlichen Empfindungen bemerken Sie?}

\\ctmmTextArea[12cm]{3}{K√∂rperliche Empfindungen}{koerper}

\\vspace{0.5cm}
\\textbf{Stress-Level (1-10):}
\\ctmmTextField[3cm]{Level}{stress_level}
\\end{ctmmPurpleBox}

\\vspace{1cm}

\\begin{ctmmOrangeBox}{Schritt 4: Handlungsoptionen}
\\textbf{Welche M√∂glichkeiten haben Sie in dieser Situation?}

\\ctmmTextArea[12cm]{4}{Handlungsoptionen}{handlungen}

\\vspace{0.5cm}
\\textbf{Welche Option w√§hlen Sie und warum?}
\\ctmmTextArea[12cm]{2}{Gew√§hlte Option}{gewaehlt}
\\end{ctmmOrangeBox}

\\subsection{Reflexion f√ºr das Paar}

\\begin{ctmmGreenBox}{Gemeinsame Bearbeitung}
\\textbf{F√ºhren Sie dieses Gespr√§ch gemeinsam:}

\\begin{enumerate}
    \\item Teilen Sie Ihre Ergebnisse miteinander (je 5 Minuten ohne Unterbrechung)
    \\item Finden Sie Gemeinsamkeiten in Ihren Wahrnehmungen
    \\item Entwickeln Sie gemeinsam eine Strategie f√ºr √§hnliche Situationen
\\end{enumerate}

\\textbf{Gemeinsame Erkenntnisse:}
\\ctmmTextArea[12cm]{3}{Erkenntnisse}{erkenntnisse}

\\textbf{Vereinbarte Strategie:}
\\ctmmTextArea[12cm]{2}{Strategie}{strategie}
\\end{ctmmGreenBox}

\\subsection{Therapeutische Notizen}
\\textit{Dieser Bereich ist f√ºr Notizen der therapeutischen Fachkraft vorgesehen.}

\\ctmmTextArea[12cm]{4}{Therapeutische Beobachtungen}{therapeut_notizen}

% Navigation
\\vspace{1cm}
\\begin{center}
\\faCompass{} \\textcolor{ctmmBlue}{\\textbf{Weiterf√ºhrende Module:}} 
\\textcolor{ctmmGray}{Triggermanagement | Bindungsleitfaden | Notfallkarten}
\\end{center}`;
    }

    /**
     * Generate Therapeutic Tool template
     */
    generateTool(title, description, filename) {
        return `% ${filename} - CTMM Therapeutisches Tool
% Generated by CTMM Module Generator
% Therapeutic tool for immediate application in neurodiverse couples therapy

\\section{${title}}
\\label{sec:${filename.replace('.tex', '').replace(/[^a-zA-Z0-9]/g, '-')}}

\\begin{ctmmOrangeBox}{Sofort anwendbares Tool}
${description || 'Dieses therapeutische Tool kann unmittelbar in kritischen Situationen angewendet werden und basiert auf der CTMM-Methodik f√ºr neurodiverse Paare.'}
\\end{ctmmOrangeBox}

\\subsection{Anwendungsbereiche}
\\begin{itemize}
    \\item \\textcolor{ctmmRed}{\\textbf{Akute Stresssituationen}}
    \\item \\textcolor{ctmmBlue}{\\textbf{Emotionale Dysregulation}}
    \\item \\textcolor{ctmmPurple}{\\textbf{Kommunikationsschwierigkeiten}}
    \\item \\textcolor{ctmmGreen}{\\textbf{Pr√§ventive Anwendung}}
\\end{itemize}

\\subsection{Schritt-f√ºr-Schritt Anleitung}

\\begin{ctmmBlueBox}{Vorbereitung (30 Sekunden)}
\\begin{enumerate}
    \\item \\textbf{STOPP} - Unterbrechen Sie die aktuelle Aktivit√§t
    \\item \\textbf{Atmen} - Nehmen Sie drei tiefe Atemz√ºge
    \\item \\textbf{Orientieren} - Wo bin ich? Was passiert gerade?
\\end{enumerate}
\\end{ctmmBlueBox}

\\vspace{0.5cm}

\\begin{ctmmGreenBox}{Durchf√ºhrung (2-3 Minuten)}
\\textbf{F√ºhren Sie folgende Schritte nacheinander aus:}

\\begin{description}
    \\item[Schritt 1:] \\textcolor{ctmmBlue}{\\textbf{Catch}} - Erkennen Sie den aktuellen Zustand
    \\item[Schritt 2:] \\textcolor{ctmmOrange}{\\textbf{Track}} - Notieren Sie (mental oder schriftlich) was Sie wahrnehmen
    \\item[Schritt 3:] \\textcolor{ctmmPurple}{\\textbf{Map}} - Verbinden Sie die Wahrnehmung mit bekannten Mustern
    \\item[Schritt 4:] \\textcolor{ctmmGreen}{\\textbf{Match}} - W√§hlen Sie eine passende Reaktion
\\end{description}
\\end{ctmmGreenBox}

\\vspace{0.5cm}

\\begin{ctmmPurpleBox}{Nachbereitung (1-2 Minuten)}
\\begin{itemize}
    \\item Kurze Reflexion: Hat das Tool geholfen?
    \\item Information an Partner*in (falls anwesend)
    \\item Notiz f√ºr sp√§tere therapeutische Besprechung
\\end{itemize}
\\end{ctmmPurpleBox}

\\subsection{Quick Reference Card}

\\begin{center}
\\begin{tcolorbox}[colback=ctmmYellow!10, colframe=ctmmOrange, title=\\textbf{${title} - Kurzanleitung}]
\\textbf{1. STOPP} - Aktivit√§t unterbrechen \\\\
\\textbf{2. ATMEN} - 3x tief durchatmen \\\\
\\textbf{3. WAHRNEHMEN} - Was passiert gerade? \\\\
\\textbf{4. HANDELN} - Bewusste Entscheidung treffen \\\\
\\textbf{5. REFLEKTIEREN} - Kurze Nachbesprechung
\\end{tcolorbox}
\\end{center}

\\subsection{F√ºr Partner*innen}

\\begin{ctmmGreenBox}{Unterst√ºtzung bieten}
\\textbf{Wenn Ihr*e Partner*in dieses Tool anwendet:}
\\begin{itemize}
    \\item Geben Sie Raum und Zeit
    \\item Sprechen Sie erst, wenn er/sie bereit ist
    \\item Bieten Sie Unterst√ºtzung an, aber dr√§ngen Sie nicht
    \\item Respektieren Sie den Prozess
\\end{itemize}
\\end{ctmmGreenBox}

\\subsection{Anpassungen und Variationen}
\\textit{Dieses Tool kann individuell angepasst werden. Besprechen Sie mit Ihrer therapeutischen Fachkraft:}

\\ctmmTextArea[12cm]{3}{Individuelle Anpassungen}{anpassungen}

% Navigation
\\vspace{1cm}
\\begin{center}
\\faCompass{} \\textcolor{ctmmBlue}{\\textbf{Verwandte Tools:}} 
\\textcolor{ctmmGray}{Atemtechniken | Grounding | Notfallplan | Safewords}
\\end{center}`;
    }

    /**
     * Generate Notfallkarte (Emergency Card) template
     */
    generateNotfallkarte(title, description, filename) {
        return `% ${filename} - CTMM Notfallkarte
% Generated by CTMM Module Generator
% Emergency intervention card for crisis situations in neurodiverse couples

\\section{${title}}
\\label{sec:${filename.replace('.tex', '').replace(/[^a-zA-Z0-9]/g, '-')}}

\\begin{ctmmRedBox}{NOTFALL - Sofortige Intervention}
${description || 'Diese Notfallkarte bietet schnelle Hilfe in Krisensituationen und kann von beiden Partner*innen verwendet werden.'}
\\end{ctmmRedBox}

\\subsection{Wann diese Karte verwenden?}
\\begin{itemize}
    \\item \\textcolor{ctmmRed}{\\textbf{Akute Panikattacken}}
    \\item \\textcolor{ctmmRed}{\\textbf{Schwere Trigger-Reaktionen}}
    \\item \\textcolor{ctmmRed}{\\textbf{Emotionale √úberflutung}}
    \\item \\textcolor{ctmmRed}{\\textbf{Selbst- oder Fremdgef√§hrdung}}
\\end{itemize}

\\subsection{SOFORT-PROTOKOLL (0-2 Minuten)}

\\begin{center}
\\begin{tcolorbox}[colback=ctmmRed!10, colframe=ctmmRed, title=\\textbf{PHASE 1: SICHERHEIT}]
\\Large
\\textbf{1. SICHERHEIT PR√úFEN} \\\\
\\textbf{2. RUHE BEWAHREN} \\\\
\\textbf{3. KONTAKT HALTEN} \\\\
\\textbf{4. HILFE HOLEN (bei Bedarf)}
\\end{tcolorbox}
\\end{center}

\\subsection{Detaillierte Schritte}

\\begin{ctmmRedBox}{Schritt 1: Sicherheit (15 Sekunden)}
\\begin{itemize}
    \\item Ist die Person bei Bewusstsein?
    \\item Besteht Selbst- oder Fremdgef√§hrdung?
    \\item Ist ein sicherer Ort erreichbar?
\\end{itemize}
\\textbf{Bei Gefahr: Sofort Notruf 112!}
\\end{ctmmRedBox}

\\begin{ctmmOrangeBox}{Schritt 2: Beruhigung (1-2 Minuten)}
\\begin{itemize}
    \\item Sprechen Sie ruhig und langsam
    \\item Verwenden Sie vertraute Worte oder Safewords
    \\item Bieten Sie k√∂rperliche N√§he an (nur wenn erw√ºnscht)
    \\item Atmen Sie bewusst und h√∂rbar
\\end{itemize}
\\end{ctmmOrangeBox}

\\begin{ctmmBlueBox}{Schritt 3: Grounding (2-5 Minuten)}
\\textbf{5-4-3-2-1 Technik:}
\\begin{itemize}
    \\item \\textbf{5 Dinge} die Sie sehen k√∂nnen
    \\item \\textbf{4 Dinge} die Sie h√∂ren k√∂nnen  
    \\item \\textbf{3 Dinge} die Sie f√ºhlen k√∂nnen
    \\item \\textbf{2 Dinge} die Sie riechen k√∂nnen
    \\item \\textbf{1 Ding} das Sie schmecken k√∂nnen
\\end{itemize}
\\end{ctmmBlueBox}

\\subsection{Notfall-Kontakte}

\\begin{center}
\\begin{tcolorbox}[colback=ctmmYellow!20, colframe=ctmmRed, title=\\textbf{WICHTIGE TELEFONNUMMERN}]
\\textbf{Notruf:} 112 \\\\
\\textbf{Therapeut*in:} \\ctmmTextField[6cm]{Telefon}{therapeut_tel} \\\\
\\textbf{Vertrauensperson:} \\ctmmTextField[6cm]{Telefon}{vertrauen_tel} \\\\
\\textbf{Krisentelefon:} 0800 111 0 111 (kostenfrei)
\\end{tcolorbox}
\\end{center}

\\subsection{Nach der Krise}

\\begin{ctmmGreenBox}{Nachbereitung (wenn Ruhe eingekehrt ist)}
\\begin{enumerate}
    \\item Sorgen Sie f√ºr Grundbed√ºrfnisse (Wasser, warme Decke, etc.)
    \\item Sprechen Sie nur, wenn die Person bereit ist
    \\item Planen Sie den n√§chsten sicheren Schritt
    \\item Vereinbaren Sie zeitnahen therapeutischen Termin
    \\item Dokumentieren Sie den Vorfall (optional)
\\end{enumerate}
\\end{ctmmGreenBox}

\\subsection{Pr√§ventive Ma√ünahmen}

\\begin{ctmmPurpleBox}{Langfristige Vorbereitung}
\\textbf{Besprechen Sie mit Ihrer therapeutischen Fachkraft:}
\\begin{itemize}
    \\item Individuelle Trigger und Warnsignale
    \\item Pers√∂nliche Beruhigungsstrategien
    \\item Safewords und Kommunikationssignale
    \\item Medikament√∂se Notfalloptionen
\\end{itemize}
\\end{ctmmPurpleBox}

\\subsection{Pers√∂nliche Notizen}

\\textbf{Individuelle Trigger:}
\\ctmmTextArea[12cm]{2}{Trigger}{trigger}

\\textbf{Bew√§hrte Beruhigungsstrategien:}
\\ctmmTextArea[12cm]{2}{Strategien}{strategien}

\\textbf{Safewords:}
\\ctmmTextField[8cm]{Safewords}{safewords}

% Notfall-Referenz
\\vspace{1cm}
\\begin{center}
\\textcolor{ctmmRed}{\\textbf{\\faExclamationTriangle{} Im Zweifel: Lieber einmal zu oft Hilfe holen!}} \\\\
\\faCompass{} \\textcolor{ctmmBlue}{\\textbf{Weitere Hilfe:}} 
\\textcolor{ctmmGray}{Safewords | Triggermanagement | Therapeutische Unterst√ºtzung}
\\end{center}`;
    }

    /**
     * Generate module based on type
     */
    generateModule(type, title, description, filename) {
        switch(type) {
            case 'arbeitsblatt':
                return this.generateArbeitsblatt(title, description, filename);
            case 'tool':
                return this.generateTool(title, description, filename);
            case 'notfallkarte':
                return this.generateNotfallkarte(title, description, filename);
            default:
                throw new Error(`Unknown module type: ${type}`);
        }
    }

    /**
     * Create module file
     */
    createModuleFile(type, title, description, filename) {
        const content = this.generateModule(type, title, description, filename);
        const filePath = path.join('modules', filename);
        
        // Ensure modules directory exists
        if (!fs.existsSync('modules')) {
            fs.mkdirSync('modules');
        }
        
        fs.writeFileSync(filePath, content, 'utf8');
        console.log(`‚úÖ Module created: ${filePath}`);
        return filePath;
    }

    /**
     * Interactive module creation
     */
    async createInteractively() {
        const rl = readline.createInterface({
            input: process.stdin,
            output: process.stdout
        });

        const question = (prompt) => new Promise(resolve => rl.question(prompt, resolve));

        try {
            console.log('üéØ CTMM Module Generator');
            console.log('================================');
            
            // Module type selection
            console.log('Verf√ºgbare Modultypen:');
            Object.entries(this.moduleTypes).forEach(([key, desc], index) => {
                console.log(`${index + 1}. ${key} - ${desc}`);
            });
            
            const typeChoice = await question('W√§hlen Sie einen Modultyp (1-3): ');
            const typeKeys = Object.keys(this.moduleTypes);
            const selectedType = typeKeys[parseInt(typeChoice) - 1];
            
            if (!selectedType) {
                throw new Error('Ung√ºltige Auswahl');
            }
            
            // Module details
            const title = await question('Titel des Moduls: ');
            const description = await question('Beschreibung (optional): ');
            const filename = await question('Dateiname (ohne .tex): ') + '.tex';
            
            // Create module
            const filePath = this.createModuleFile(selectedType, title, description, filename);
            
            console.log('\\n‚úÖ Modul erfolgreich erstellt!');
            console.log(`üìÅ Pfad: ${filePath}`);
            console.log(`üîß F√ºgen Sie folgende Zeile zu main.tex hinzu:`);
            console.log(`   \\\\input{modules/${filename.replace('.tex', '')}}`);
            
        } catch (error) {
            console.error(`‚ùå Fehler: ${error.message}`);
        } finally {
            rl.close();
        }
    }
}

// CLI Interface
if (require.main === module) {
    const generator = new CTMMModuleGenerator();
    
    const args = process.argv.slice(2);
    
    if (args.length === 0) {
        // Interactive mode
        generator.createInteractively();
    } else if (args.length >= 3) {
        // Command line mode
        const [type, title, filename, description] = args;
        try {
            generator.createModuleFile(type, title, description || '', filename);
        } catch (error) {
            console.error(`‚ùå Fehler: ${error.message}`);
            process.exit(1);
        }
    } else {
        console.log('Verwendung:');
        console.log('  node module-generator.js                    # Interaktiver Modus');
        console.log('  node module-generator.js <typ> <titel> <dateiname> [beschreibung]');
        console.log('');
        console.log('Beispiel:');
        console.log('  node module-generator.js tool "Atemtechnik" "atemtechnik.tex" "Beruhigende Atem√ºbung"');
        process.exit(1);
    }
}

module.exports = CTMMModuleGenerator;